<nav id="navbar-special"
     class="navbar navbar-light navbar-expand-sm {% if site.navbar_fixed %}fixed-top{% else %}sticky-top{% endif %} {% if page.navbar_auto_hide %}navbar-autohide-enabled{% endif %} {% if page.toggle_down %}navbar-toggle-always{% endif %}"
     {% if page.special_navbar_color %}
     style="background-color: {{ page.special_navbar_color }};"
     {% endif %}
     role="navigation">
  <div class="container">
    <!-- Logo Section (Left) -->
    <div class="navbar-brand-container">
      {% if page.special_navbar_logo_one %}
        <a class="navbar-brand logo" href="{{ site.baseurl }}/">
          <img src="{{ page.special_navbar_logo_one | relative_url }}" alt="{{ site.title }}" style="max-height: 40px; width: auto; margin-right: 10px;" />
        </a>
      {% endif %}

      {% if page.special_navbar_logo_two %}
        <a class="navbar-brand logo" href="{{ site.baseurl }}/">
          <img src="{{ page.special_navbar_logo_two | relative_url }}" alt="{{ site.title }}" style="max-height: 40px; width: auto;" />
        </a>
      {% endif %}
    </div>
    
    <!-- Title Container (Center) -->
    <div class="navbar-title-container text-center {% if page.toggle_down %}toggle-down-title{% endif %}">
      <h1 class="navbar-title font-weight-bold">
        {% if page.special_navbar_title %}
          {{ page.special_navbar_title }}
        {% else %}
          {{ page.title }}
        {% endif %}
      </h1>
    </div>
    
    <!-- Navbar Toggle - ALWAYS COLLAPSED BY DEFAULT -->
    <button
      class="navbar-toggler collapsed ml-auto"
      type="button"
      data-toggle="collapse"
      data-target="#navbarSpecialNav"
      aria-controls="navbarSpecialNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar top-bar"></span>
      <span class="icon-bar middle-bar"></span>
      <span class="icon-bar bottom-bar"></span>
    </button>
    
    <!-- Right-aligned control elements - COLLAPSED BY DEFAULT -->
    <div class="collapse navbar-collapse text-right" id="navbarSpecialNav"
         {% if page.special_navbar_color %}
         style="background-color: {{ page.special_navbar_color }};"
         {% endif %}>
      <ul class="navbar-nav ml-auto flex-nowrap">
        {% if page.toggle_down %}
          <!-- About -->
          {% for page in site.pages %}
            {% if page.permalink == '/' %} {% assign about_title = page.title %} {% endif %}
          {% endfor %}
          
          <li class="nav-item {% if page.permalink == '/' %}active{% endif %}">
            <a class="nav-link" href="{{ '/' | relative_url }}">
              {{- about_title }}
              {% if page.permalink == '/' %}
                <span class="sr-only">(current)</span>
              {% endif %}
            </a>
          </li>

          <!-- Other pages -->
          {% assign sorted_pages = site.pages | sort: 'nav_order' %}
          {% for p in sorted_pages %}
            {% if p.nav and p.autogen == null %}
              {% if p.dropdown %}
                {% assign has_active_child = false %}
                {% for child in p.children %}
                  {% if page.title == child.title %}
                    {% assign has_active_child = true %}
                  {% endif %}
                {% endfor %}
                <li class="nav-item dropdown {% if page.title == p.title or has_active_child %}active{% endif %}">
                  
                    class="nav-link dropdown-toggle"
                    href="#"
                    id="navbarDropdown"
                    role="button"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                  >
                    {{- p.title }}
                    {% if page.title == p.title or has_active_child %}
                      <span class="sr-only">(current)</span>
                    {% endif %}
                  </a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                    {% for child in p.children %}
                      {% if child.title == 'divider' %}
                        <div class="dropdown-divider"></div>
                      {% else %}
                        
                          class="dropdown-item {% if page.title == child.title %}active{% endif %}"
                          href="{% if child.permalink contains '://' %}{{ child.permalink }}{% else %}{{ child.permalink | relative_url }}{% endif %}"
                        >
                          {{- child.title -}}
                        </a>
                      {% endif %}
                    {% endfor %}
                  </div>
                </li>
              {% else %}
                {% assign parent_link = p.permalink | remove: 'index.html' %}
                <li class="nav-item {% if page.url contains parent_link %}active{% endif %}">
                  {%- if p.permalink contains '://' -%}
                    {%- assign url = p.permalink -%}
                  {%- elsif p.permalink contains '/blog/' -%}
                    {%- assign url = '/blog/' -%}
                  {%- else -%}
                    {%- assign url = p.url -%}
                  {%- endif %}
                  <a class="nav-link" href="{{ url | relative_url }}">
                    {{- p.title }}
                    {% if page.url contains p.url %}
                      <span class="sr-only">(current)</span>
                    {% endif %}
                  </a>
                </li>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {% if site.enable_darkmode %}
          <!-- Toggle theme mode -->
          <li class="toggle-container">
            <button id="light-toggle" title="Change theme">
              <i class="ti ti-sun-moon" id="light-toggle-system"></i>
              <i class="ti ti-moon-filled" id="light-toggle-dark"></i>
              <i class="ti ti-sun-filled" id="light-toggle-light"></i>
            </button>
          </li>
        {% endif %}
        
        {% if page.language_switch %}
          <li class="nav-item">
            <button id="navbar-language-toggle" title="{% if page.lang == 'en' %}Switch to TH{% else %}Switch to EN{% endif %}"
                    class="navbar-control-btn language-btn-navbar {% if page.lang == 'en' %}en{% else %}alt-lang{% endif %}"
                    onclick="window.location.href='{{ page.alternate_lang_url | relative_url }}'">
              <div class="toggle-indicator">
                {% if page.lang == 'en' %}
                  <span class="navbar-lang-icon">
                     <img src="{{ '/assets/img/icon/thailand.png' | relative_url }}" alt="TH" class="circle-flag" />
                  </span>
                {% else %}
                  <span class="navbar-lang-icon">
                    <i class="ti ti-world"></i>
                  </span>
                {% endif %}
              </div>
              <span class="lang-label">
                {% if page.lang == 'en' %}TH{% else %}EN{% endif %}
              </span>
            </button>
          </li>
        {% endif %}
        
        {% if site.search_enabled %}
          <!-- Search -->
          <li class="nav-item">
            <button id="search-toggle" title="Search" onclick="openSearchModal()">
              <span class="nav-link"><i class="ti ti-search"></i></span>
            </button>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Add force initialization script to ensure auto-hide works -->
{% if page.navbar_auto_hide %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Force the body class to be set
    document.body.classList.add('navbar-auto-hide');
    
    // Force the special navbar to have the class
    const specialNavbar = document.getElementById('navbar-special');
    if (specialNavbar) {
      specialNavbar.classList.add('navbar-autohide-enabled');
      
      // Force a reflow to ensure the browser recognizes the class
      void specialNavbar.offsetWidth;
    }
  });
</script>
{% endif %}

<!-- Direct script to handle special navbar theme toggle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Direct event handler for special navbar theme button
    const specialThemeButton = document.querySelector('#special-navbar #light-toggle');
    if (specialThemeButton) {
      specialThemeButton.addEventListener('click', function() {
        // Try to find the theme toggle function
        if (typeof toggleThemeSetting === 'function') {
          toggleThemeSetting();
        } else if (window.toggleThemeSetting) {
          window.toggleThemeSetting();
        } else {
          // Fallback: manually toggle through light/dark/system
          const html = document.documentElement;
          const currentTheme = localStorage.getItem('theme') || 'system';
          
          let newTheme = 'light';
          if (currentTheme === 'light') newTheme = 'dark';
          if (currentTheme === 'dark') newTheme = 'system';
          
          localStorage.setItem('theme', newTheme);
          html.setAttribute('data-theme-setting', newTheme);
          
          if (newTheme === 'system') {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            html.setAttribute('data-theme', isDark ? 'dark' : 'light');
          } else {
            html.setAttribute('data-theme', newTheme);
          }
          
          // Update the icon display
          const systemIcon = document.querySelector('#light-toggle-system');
          const darkIcon = document.querySelector('#light-toggle-dark');
          const lightIcon = document.querySelector('#light-toggle-light');
          
          if (systemIcon && darkIcon && lightIcon) {
            systemIcon.style.display = newTheme === 'system' ? 'block' : 'none';
            darkIcon.style.display = newTheme === 'dark' ? 'block' : 'none';
            lightIcon.style.display = newTheme === 'light' ? 'block' : 'none';
          }
          
          // Trigger theme application
          if (typeof applyTheme === 'function') {
            applyTheme();
          }
        }
      });
    }
  });
</script>