{% assign img_path = include.path | remove: '.jpg' | remove: '.jpeg' | remove: '.png' | remove: '.tiff' | remove: '.gif' %}
{% assign parts = include.path | split: '.' %}
{% assign ext = parts.last %}
{% assign is_google_drive = include.path | downcase | contains: 'drive.google.com' or include.path | downcase | contains: 'googleusercontent.com' %}

<figure
  {% if include.slot %}
    slot="{{ include.slot }}"
  {% endif %}
>
  <picture>
    {% if is_google_drive %}
      <!-- Google Drive image optimization -->
      <source 
        media="(max-width: 480px)" 
        srcset="{{ include.path }}&sz=w480">
      <source 
        media="(max-width: 768px)" 
        srcset="{{ include.path }}&sz=w768">
      <source 
        media="(max-width: 1200px)" 
        srcset="{{ include.path }}&sz=w1200">
    {% elsif site.imagemagick.enabled %}
      {% unless include.avoid_scaling %}
        <source
          class="responsive-img-srcset"
          {% if ext == 'gif' or ext == 'jpeg' or ext == 'jpg' or ext == 'png' or ext == 'tiff' %}
            srcset="{% for i in site.imagemagick.widths %}{{ img_path | relative_url }}-{{ i }}.webp {{ i }}w,{% endfor %}"
            type="image/webp"
          {% else %}
            srcset="{{ include.path | relative_url }}"
          {% endif %}
          {% if include.sizes %}
            sizes="{{ include.sizes }}"
          {% else %}
            sizes="(max-width: 480px) 95vw, (max-width: 768px) 85vw, 75vw"
          {% endif %}
        >
      {% endunless %}
    {% endif %}
    <img
      src="{% if include.url %}{{ include.url }}{% elsif include.cache_bust %}{{ include.path | relative_url | bust_file_cache }}{% else %}{{ include.path | relative_url }}{% endif %}"
      {% if include.class %}
        class="{{ include.class }}"
      {% endif %}
      {% if include.width %}
        width="{{ include.width }}"
      {% else %}
        width="100%"
      {% endif %}
      {% if include.height %}
        height="{{ include.height }}"
      {% else %}
        height="auto"
      {% endif %}
      {% if include['min-width'] or include['min-height'] or include['max-width'] or include['max-height'] %}
        style="
          {% if include['min-width'] %}
            min-width: {{ include.min-width }};
          {% endif %}
          {% if include['min-height'] %}
            min-height: {{ include.min-height }};
          {% endif %}
          {% if include['max-width'] %}
            max-width: {{ include.max-width }};
          {% endif %}
          {% if include['max-height'] %}
            max-height: {{ include.max-height }};
          {% endif %}
        "
      {% endif %}
      {% if include.alt %}
        alt="{{ include.alt }}"
      {% endif %}
      {% if include.title %}
        title="{{ include.title }}"
      {% endif %}
      {% if include.zoomable %}
        data-zoomable
      {% endif %}
      {% if include.priority %}
        loading="eager" 
        fetchpriority="high"
      {% elsif include.loading %}
        loading="{{ include.loading }}"
      {% elsif site.lazy_loading_images %}
        loading="lazy"
      {% endif %}
      {% if is_google_drive == false %}
        onerror="this.onerror=null; $('.responsive-img-srcset').remove();"
      {% endif %}
    >
  </picture>

  {% if include.caption %}
    <figcaption class="caption">{{ include.caption }}</figcaption>
  {% endif %}
</figure>